#!/bin/bash

# Path to your own script
# http://stackoverflow.com/questions/4774054/reliable-way-for-a-bash-script-to-get-the-full-path-to-itself
pushd . > /dev/null
SCRIPT_PATH="${BASH_SOURCE[0]}";
  while([ -h "${SCRIPT_PATH}" ]) do 
    cd "`dirname "${SCRIPT_PATH}"`"
    SCRIPT_PATH="$(readlink "`basename "${SCRIPT_PATH}"`")"; 
  done
cd "`dirname "${SCRIPT_PATH}"`" > /dev/null
SCRIPT_PATH="`pwd`";
popd  > /dev/null

source $SCRIPT_PATH/quiltenv.rc

LOGMODE=DEBUG
openport()
{
    iptables -L | grep "tcp dpt:$1" || sudo iptables -I INPUT -p tcp -m tcp --dport $1 -j ACCEPT
}
closeport()
{
    local rnum=$(iptables -L --line-numbers | grep "tcp dpt:$1" | awk '{print $1'})
    if [ "$rnum" ] ; then iptables -D INPUT $rnum; fi
}
dostop()
{
    echo "Stopping quilt"
    quilt_smd stop
    sleep 1
    quilt_qmd stop
    sleep 1
    quilt_registrar stop

    # closeport 4242
    # closeport 4243
}

dostart()
{
    # openport 4242
    # openport 4243
    
    quilt_registrar start -l $LOGMODE 
    sleep 1
    quilt_qmd start -l $LOGMODE 
    sleep 1
    quilt_smd start -l $LOGMODE 
}

case "$1" in
  install)
    echo "Checking Dependencies"
    cat /etc/redhat-release && yum install -y python-pyro python-daemon python-argparse

    echo "Installing quilt"
    ln -s $SCRIPT_PATH/quilt /etc/init.d/quilt 
    chkconfig quilt on
    dostart
    ;;

  uninstall)
    dostop 
    echo "Uninstalling quilt"
    rm /etc/init.d/quilt
    ;;
  start)
    dostart
    ;;
  stop)
    dostop
    ;;
  *)
    # Refuse to do other stuff
    echo "Usage: $0 {start|stop|install|uninstall}"
    exit 1
    ;;
esac

exit 0
